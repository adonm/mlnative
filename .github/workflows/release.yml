name: Release

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  lint:
    name: Lint and Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: pip install ruff mypy
      
      - name: Run ruff linter
        run: ruff check mlnative/ tests/ examples/
      
      - name: Run ruff format check
        run: ruff format mlnative/ tests/ examples/ --check
      
      - name: Run mypy type check
        run: mypy mlnative/

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      - name: Install Python dependencies
        run: pip install -e ".[dev]"
      
      - name: Build Rust binary
        run: cd rust && cargo build --release
      
      - name: Run unit tests
        run: pytest tests/ -v --tb=short -k "Validation"

  build-binary:
    name: Build binary ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x64
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-latest
            platform: linux-arm64
            target: aarch64-unknown-linux-gnu
          - os: macos-latest
            platform: darwin-arm64
            target: aarch64-apple-darwin
          - os: macos-13
            platform: darwin-x64
            target: x86_64-apple-darwin
          - os: windows-latest
            platform: win32-x64
            target: x86_64-pc-windows-msvc
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        if: runner.os != 'Windows'
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install Rust (Windows)
        if: runner.os == 'Windows'
        uses: dtolnay/rust-toolchain@stable

      - name: Add Rust target (cross-compile)
        if: matrix.target != ''
        run: |
          rustup target add ${{ matrix.target }}
        shell: bash

      - name: Build Rust binary
        run: |
          cd rust
          cargo build --release --target ${{ matrix.target }}
        shell: bash

      - name: Prepare binary (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p mlnative/bin
          cp rust/target/${{ matrix.target }}/release/mlnative-render mlnative/bin/mlnative-render-${{ matrix.platform }}
          chmod +x mlnative/bin/mlnative-render-${{ matrix.platform }}

      - name: Prepare binary (Windows)
        if: runner.os == 'Windows'
        run: |
          mkdir -p mlnative/bin
          copy rust\target\${{ matrix.target }}\release\mlnative-render.exe mlnative\bin\mlnative-render-${{ matrix.platform }}.exe

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.platform }}
          path: mlnative/bin/*

  build-wheels:
    name: Build platform wheels
    needs: build-binary
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    strategy:
      matrix:
        platform: [linux-x64, linux-arm64, darwin-x64, darwin-arm64, win32-x64]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: binary-${{ matrix.platform }}
          path: mlnative/bin/

      - name: Install build dependencies
        run: pip install build

      - name: Build platform-specific wheel
        run: |
          # Create platform-specific wheel
          python -m build --wheel
          
          # Rename wheel with correct platform tag
          python << 'EOF'
          import os
          import glob
          import platform
          
          wheel_dir = "dist"
          wheels = glob.glob(f"{wheel_dir}/*.whl")
          
          if not wheels:
              print("No wheels found!")
              exit(1)
          
          for wheel in wheels:
              # Get platform tag
              platform_tag = "${{ matrix.platform }}"
              platform_map = {
                  "linux-x64": "manylinux_2_28_x86_64",
                  "linux-arm64": "manylinux_2_28_aarch64", 
                  "darwin-x64": "macosx_10_12_x86_64",
                  "darwin-arm64": "macosx_11_0_arm64",
                  "win32-x64": "win_amd64"
              }
              tag = platform_map.get(platform_tag, "any")
              
              # Rename wheel
              new_name = wheel.replace("-any.whl", f"-{tag}.whl")
              os.rename(wheel, new_name)
              print(f"Renamed: {wheel} -> {new_name}")
          EOF

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.platform }}
          path: dist/*.whl

  build-sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install build dependencies
        run: pip install build

      - name: Build sdist
        run: python -m build --sdist

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz

  github-release:
    name: Create GitHub Release
    needs: [build-wheels, build-sdist]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: "wheel-*|sdist"
          merge-multiple: true

      - name: List artifacts
        run: ls -lh dist/

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ github.ref_name }}" \
            --title "${{ github.ref_name }}" \
            --generate-notes \
            dist/*.whl dist/*.tar.gz

  publish-pypi:
    name: Publish to PyPI
    needs: [build-wheels, build-sdist]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    environment:
      name: pypi
      url: https://pypi.org/p/mlnative
    permissions:
      id-token: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: "wheel-*|sdist"
          merge-multiple: true

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
